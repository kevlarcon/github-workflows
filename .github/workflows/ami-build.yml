name: Build AMI with Packer

on:
  workflow_call:
    inputs:
      aws_region:
        description: 'AWS region'
        required: false
        type: string
        default: 'us-east-2'
      app_name:
        description: 'Application name (for SSM parameter naming)'
        required: true
        type: string
    secrets:
      aws_deploy_role:
        description: 'AWS IAM role ARN for OIDC authentication'
        required: true
      gh_private_repo_token:
        description: 'GitHub token for accessing private repos (kevcons)'
        required: true
    outputs:
      ami_id:
        description: 'The ID of the built AMI'
        value: ${{ jobs.build-ami.outputs.ami_id }}

jobs:
  build-ami:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    outputs:
      ami_id: ${{ steps.store-ami.outputs.ami_id }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: ${{ inputs.aws_region }}
        role-to-assume: ${{ secrets.aws_deploy_role }}
        role-session-name: github-actions-ami-build

    - name: Setup Packer
      uses: hashicorp/setup-packer@main
      with:
        version: 'latest'

    - name: Clone infrastructure-catalog
      env:
        GH_TOKEN: ${{ secrets.gh_private_repo_token }}
      run: |
        # Clone infrastructure-catalog for packer templates
        echo "Cloning infrastructure-catalog..."
        curl -sL -H "Authorization: token ${GH_TOKEN}" \
          "https://api.github.com/repos/kevlarcon/infrastructure-catalog/tarball/main" \
          -o /tmp/infrastructure-catalog.tar.gz

        mkdir -p /opt/infrastructure-catalog
        tar -xzf /tmp/infrastructure-catalog.tar.gz -C /opt/infrastructure-catalog --strip-components=1
        echo "✓ infrastructure-catalog available at /opt/infrastructure-catalog"

    - name: Initialize Packer plugins
      run: |
        # Find packer template and init plugins
        if [ -f ".kevcons.yaml" ]; then
          TEMPLATE=$(grep 'packer_template:' .kevcons.yaml | awk '{print $NF}')
          if [ -n "$TEMPLATE" ] && [ -f "$TEMPLATE" ]; then
            echo "Initializing Packer plugins for $TEMPLATE"
            packer init "$TEMPLATE"
          else
            echo "No packer template found at $TEMPLATE, skipping init"
          fi
        fi

    - name: Debug secrets
      run: |
        echo "Token length: ${#TOKEN}"
        echo "Token first 5: ${TOKEN:0:5}"
      env:
        TOKEN: ${{ secrets.gh_private_repo_token }}

    - name: Install kevcons
      uses: kevlarcon/github-workflows/actions/install-kevcons@main
      with:
        github-token: ${{ secrets.gh_private_repo_token }}

    - name: Build AMI
      env:
        GH_TOKEN: ${{ secrets.gh_private_repo_token }}
      run: |
        echo "Building AMI for ${{ inputs.app_name }}..."
        kevcons build

    - name: Store AMI ID in SSM
      id: store-ami
      run: |
        # Get AMI ID from manifest
        AMI_ID=$(cat ~/.kevcons/${{ inputs.app_name }}/manifest.json | jq -r '.builds[0].artifact_id' | cut -d: -f2)
        echo "Built AMI: $AMI_ID"

        # Store in SSM
        aws ssm put-parameter \
          --name /${{ inputs.app_name }}/latest-ami-id \
          --value $AMI_ID \
          --overwrite \
          --region ${{ inputs.aws_region }}

        aws ssm put-parameter \
          --name /${{ inputs.app_name }}/ami/${{ github.sha }} \
          --value $AMI_ID \
          --overwrite \
          --region ${{ inputs.aws_region }}

        # Output for next job
        echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
        echo "✓ AMI $AMI_ID stored in SSM"

    - name: AMI build details
      run: |
        echo "AMI build completed successfully!"
        echo "AMI ID: ${{ steps.store-ami.outputs.ami_id }}"
        echo "Git SHA: ${{ github.sha }}"
        echo "SSM Parameters:"
        echo "  - /${{ inputs.app_name }}/latest-ami-id"
        echo "  - /${{ inputs.app_name }}/ami/${{ github.sha }}"
